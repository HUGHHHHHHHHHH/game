<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åŸå¸‚ç”Ÿå­˜æ¸¸æˆ</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: #f2f2f2;
    }
    #gameContainer {
      max-width: 700px;
      margin: 0 auto;
      padding: 1em;
      background: #fff;
      box-sizing: border-box;
      min-height: 100vh;
    }
    h1, h2, h3 {
      margin: 0.5em 0;
    }
    .panel {
      border: 1px solid #ccc;
      padding: 1em;
      margin-bottom: 1em;
      background: #fafafa;
    }
    .hidden {
      display: none;
    }
    .choiceButton {
      display: block;
      width: 100%;
      margin: 0.25em 0;
      padding: 0.5em;
      color: #fff;
      background: #007bff;
      border: none;
      cursor: pointer;
      font-size: 0.9em;
    }
    .choiceButton:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .proceedButton {
      padding: 0.5em;
      border: none;
      cursor: pointer;
      background: #28a745;
      color: #fff;
    }
    .restartButton {
      background: #dc3545;
      color: #fff;
      padding: 0.5em;
      border: none;
      cursor: pointer;
    }
    .logPanel {
      border: 1px solid #ccc;
      padding: 0.5em;
      max-height: 250px;
      overflow-y: auto;
      background: #f9f9f9;
      font-size: 0.9em;
    }
    #introText {
      font-style: italic;
      margin-bottom: 1em;
      background: #fcfcfc;
      padding: 0.5em;
      border-left: 4px solid #ccc;
      line-height: 1.4em;
    }
    /* Styling for the status table */
    #statusTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
    }
    #statusTable th, #statusTable td {
      border: 1px solid #ddd;
      padding: 0.75em;
      text-align: center;
    }
    #statusTable th {
      background-color: #007bff;
      color: white;
      font-weight: bold;
    }
    #statusTable tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    #statusTable tr:hover {
      background-color: #f1f1f1;
    }

    details#guideDetails{margin-bottom:1em;border:1px solid #ccc;background:#fafafa;}
    details#guideDetails summary{cursor:pointer;font-weight:bold;padding:0.7em;background:#e9ecef;}
    details#guideDetails[open] summary{border-bottom:1px solid #ccc;}
    details#guideDetails .guideContent{padding:1em;background:#fcfcfc;line-height:1.6em;font-size:0.95em;}
    details#guideDetails ul{margin:0 0 0 1.2em;padding:0;}
    details#guideDetails li{margin:0.3em 0;}
    @media(max-width:500px){
      .choiceButton{font-size:0.8em;}
      details#guideDetails .guideContent{font-size:0.9em;}
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <h1>åŸå¸‚ç”Ÿå­˜æ¸¸æˆ</h1>
    <div id="introText">
      åœ¨è¿™ä¸ªåŸå¸‚ç”Ÿå­˜å¹¶ä¸å®¹æ˜“ï¼šä½ éœ€è¦æ‰¾å·¥ä½œã€æ”¯ä»˜æˆ¿ç§Ÿã€ä¿æŒå¥åº·ï¼Œå¹¶é€šè¿‡é­…åŠ›ã€æ™ºåŠ›ã€è´¢å•†ä¸ä½“åŠ›ä¸æ–­æå‡è‡ªå·±ã€‚<br>
      éšç€æ—¶é—´æ¨ç§»ï¼Œä½ ä¼šæ…¢æ…¢å˜è€ï¼Œä½†ä½ ä¹Ÿå°†ä¼šè·å¾—æ›´å¤šçš„æœºé‡ä¸æŒ‘æˆ˜ï¼<br>
      <b>ç›®æ ‡ï¼š</b><br>
      åœ¨ 20 ä¸ªäº‹ä»¶åæ”’å¤Ÿä¸¤ä¸‡å…ƒèµ„é‡‘ï¼Œåœ¨è¿™åº§åŸå¸‚æ‰ç¨³è„šè·Ÿã€‚<br>
      åœ¨ 40 ä¸ªäº‹ä»¶åæ”’å¤Ÿå…«ä¸‡å…ƒèµ„é‡‘ï¼Œæˆå®¶ç«‹ä¸šã€‚<br>
      åœ¨ 60 ä¸ªäº‹ä»¶åæ”’å¤Ÿä¸‰åä¸‡å…ƒèµ„é‡‘ï¼ŒåŠŸæˆåå°±ã€è¡£é”¦è¿˜ä¹¡ã€‚<br>
    </div>

    <div id="configPanel" class="panel">
      <h2>å¼€å§‹æ¸¸æˆ</h2>
      <label for="difficultySelect">é€‰æ‹©éš¾åº¦:</label>
      <select id="difficultySelect">
        <option value="">--é€‰æ‹©--</option>
        <option value="simple">ç®€å•</option>
        <option value="medium">ä¸­ç­‰</option>
        <option value="hard">å›°éš¾</option>
        <option value="guru">å¤§å¸ˆ</option>
      </select>
      <p id="difficultyInfo"></p>
      <button id="startButton" disabled>å¼€å§‹</button>
    </div>

    <div id="statusPanel" class="panel hidden">
      <h3>è§’è‰²çŠ¶æ€</h3>
      <table id="statusTable">
        <thead>
          <tr>
            <th>èµ„é‡‘</th>
            <th>å¥åº·</th>
            <th>èŒä¸š</th>
            <th>é­…åŠ›</th>
            <th>æ™ºåŠ›</th>
            <th>è´¢å•†</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="moneyStatus"></td>
            <td id="healthStatus"></td>
            <td id="jobStatus"></td>
            <td id="charmStatus"></td>
            <td id="intelligenceStatus"></td>
            <td id="financeStatus"></td>
          </tr>
          <tr>
            <th>ä½“åŠ›</th>
            <th>è¿›åº¦</th>
            <th>æˆ¿ç§Ÿ</th>
            <th>é˜¶æ®µå¥åº·æˆæœ¬</th>
            <th>å·¥èµ„</th>
            <th></th>
          </tr>
          <tr>
            <td id="strengthStatus"></td>
            <td id="progressStatus"></td>
            <td id="rentDisplay"></td>
            <td id="healthCostDisplay"></td>
            <td id="jobPayDisplay"></td>
            <td></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="eventPanel" class="panel hidden">
      <h3 id="eventTitle"></h3>
      <p id="eventDescription"></p>
      <div id="choiceContainer"></div>
      <button id="proceedButton" class="proceedButton hidden">ç»§ç»­</button>
    </div>

    <!-- <div id="milestonePanel" class="panel hidden">
      <h3>é˜¶æ®µæ£€æŸ¥</h3>
      <p id="milestoneMessage"></p>
      <button id="milestoneProceedButton" class="proceedButton">è¿›å…¥ä¸‹ä¸€é˜¶æ®µ</button>
    </div> -->

    <div id="endPanel" class="panel hidden">
      <h2>æ¸¸æˆç»“æŸ</h2>
      <p id="endMessage"></p>
      <button id="restartButton" class="restartButton">é‡æ–°å¼€å§‹</button>
    </div>

    <div id="logPanel" class="logPanel hidden">
      <h3>è¡ŒåŠ¨è®°å½•</h3>
      <div id="actionLog"></div>
    </div>

    <details id="guideDetails">
      <summary>ğŸ“– ç©å®¶æŒ‡å—ï¼ˆç‚¹å‡»å±•å¼€ / æ”¶èµ·ï¼‰</summary>
      <div class="guideContent">
        <h2>ç©å®¶æŒ‡å— â€“ åŸå¸‚ç”Ÿå­˜æ¸¸æˆ</h2>

        <h3>1. æ¸¸æˆç›®æ ‡</h3>
        <ul>
          <li>åœ¨ç¬¬&nbsp;20&nbsp;ä¸ªäº‹ä»¶æ—¶æ‹¥æœ‰<strong>â‰¥ 2 ä¸‡å…ƒ</strong></li>
          <li>åœ¨ç¬¬&nbsp;40&nbsp;ä¸ªäº‹ä»¶æ—¶æ‹¥æœ‰<strong>â‰¥ 8 ä¸‡å…ƒ</strong></li>
          <li>åœ¨ç¬¬&nbsp;60&nbsp;ä¸ªäº‹ä»¶æ—¶æ‹¥æœ‰<strong>â‰¥ 30 ä¸‡å…ƒ</strong>ï¼ˆé€šå…³ï¼‰</li>
          <li>è‹¥<strong>èµ„é‡‘</strong>æˆ–<strong>å¥åº·</strong>â‰¤ 0ï¼Œç«‹å³å¤±è´¥</li>
        </ul>

        <h3>2. æ¯å›åˆæµç¨‹</h3>
        <ol>
          <li>ç³»ç»Ÿå…ˆç»“ç®—å½“å›åˆï¼š
            <ul>
              <li>é¢†å–å½“å‰<strong>èŒä¸š</strong>çš„<strong>å·¥èµ„</strong></li>
              <li>æ”¯ä»˜<strong>æˆ¿ç§Ÿ</strong></li>
              <li>æ‰£é™¤<strong>é˜¶æ®µå¥åº·æˆæœ¬</strong>åŠ<strong>èŒä¸šå¥åº·æ¶ˆè€—</strong></li>
            </ul>
          </li>
          <li>é˜…è¯»äº‹ä»¶å†…å®¹</li>
          <li>ä»è‹¥å¹²<strong>é€‰é¡¹</strong>ä¸­é€‰æ‹©å…¶ä¸€</li>
          <li>æŸ¥çœ‹ç»“æœåç‚¹å‡»<span style="color:#28a745;">â€œç»§ç»­â€</span>è¿›å…¥ä¸‹ä¸€äº‹ä»¶</li>
        </ol>

        <h3>3. å¦‚ä½•å¼€å§‹æ¸¸æˆ</h3>
        <ol>
          <li>ç‚¹å‡»ã€Œå¼€å§‹æ¸¸æˆã€</li>
          <li>é€‰æ‹©<strong>éš¾åº¦</strong>ï¼š
            <ul>
              <li>ç®€å•&nbsp;â†’ ä½æˆ¿ç§Ÿ / ä½å¥åº·æ¶ˆè€— / åˆå§‹èƒ½åŠ›é«˜</li>
              <li>ä¸­ç­‰</li>
              <li>å›°éš¾</li>
              <li>å¤§å¸ˆ&nbsp;â†’ æˆ¿ç§Ÿä¸æ¶ˆè€—æé«˜ / åˆå§‹èƒ½åŠ›æä½</li>
            </ul>
          </li>
          <li>ç³»ç»Ÿéšæœºåˆ†é…å››é¡¹<strong>èƒ½åŠ›å€¼</strong>ï¼š
            é­…åŠ›ã€æ™ºåŠ›ã€è´¢å•†ã€ä½“åŠ›ï¼ˆéš¾åº¦è¶Šé«˜ï¼Œå¯åˆ†é…æ€»å€¼è¶Šå°‘ï¼‰</li>
        </ol>

        <h3>4. å±æ€§è¯´æ˜</h3>
        <ul>
          <li><strong>èµ„é‡‘</strong>ï¼šç”¨äºé‡Œç¨‹ç¢‘ä¸æ—¥å¸¸å¼€é”€</li>
          <li><strong>å¥åº·</strong> (0-100)ï¼šé™åˆ° 0 åˆ¤è´Ÿ</li>
          <li><strong>é­…åŠ›</strong>ï¼šæå‡ç¤¾äº¤ç±»èŒä¸šæ”¶å…¥</li>
          <li><strong>æ™ºåŠ›</strong>ï¼šéšæ—¶é—´æé«˜æŠ€æœ¯ç±»èŒä¸šæ”¶å…¥</li>
          <li><strong>è´¢å•†</strong>ï¼šæå‡å•†ä¸šç±»èŒä¸šæ”¶å…¥ï¼Œå¹¶å‡å°‘è¿™ç±»èŒä¸šçš„æ”¶å…¥æ³¢åŠ¨</li>
          <li><strong>ä½“åŠ›</strong>ï¼šæå‡ä½“åŠ›ç±»èŒä¸šæ”¶å…¥ï¼Œå¹¶é™ä½å¥åº·æ¶ˆè€—</li>
        </ul>

        <h3>5. èŒä¸šä¸å·¥èµ„å…¬å¼</h3>
        <ul>
          <li><strong>æ™®é€š</strong>ï¼šå·¥èµ„â‰ˆåŸºç¡€ Ã— (1 + æœ€é«˜å•é¡¹èƒ½åŠ›)</li>
          <li><strong>ç¤¾äº¤</strong>ï¼šå·¥èµ„â‰ˆåŸºç¡€ Ã— (1 + 5 Ã— é­…åŠ›)</li>
          <li><strong>æŠ€æœ¯</strong>ï¼šèµ·è–ª=åŸºç¡€ï¼›æ¯å›åˆæ ¹æ®æ™ºåŠ›æå‡åŸºç¡€å·¥èµ„</li>
          <li><strong>å•†ä¸š</strong>ï¼šå·¥èµ„åœ¨ <em>åŸºç¡€ Ã— (1 + 3 Ã— è´¢å•†)</em> ä¸ºä¸­å¿ƒçš„åŒºé—´å†…æ³¢åŠ¨</li>
          <li><strong>ä½“åŠ›</strong>ï¼šå·¥èµ„â‰ˆåŸºç¡€ Ã— (1 + 3 Ã— ä½“åŠ›)ï¼Œä¸”ä½“åŠ›æ¯å›åˆ+0.01</li>
        </ul>
        <p>æ›´æ¢èŒä¸šåªèƒ½é€šè¿‡äº‹ä»¶é€‰é¡¹è·å¾—<strong>æ–°å·¥ä½œ</strong>ã€‚</p>

        <h3>6. é˜¶æ®µä¸åŸå¸‚æˆæœ¬</h3>
        <ul>
          <li>äº‹ä»¶&nbsp;1-20 â†’ é˜¶æ®µ 1</li>
          <li>äº‹ä»¶ 21-40 â†’ é˜¶æ®µ 2</li>
          <li>äº‹ä»¶ 41-60 â†’ é˜¶æ®µ 3</li>
          <li>é˜¶æ®µè¶Šé«˜ï¼Œ<strong>æˆ¿ç§Ÿ</strong>ä¸<strong>å¥åº·æˆæœ¬</strong>è¶Šé«˜</li>
        </ul>

        <h3>7. é‡Œç¨‹ç¢‘æ£€æŸ¥</h3>
        <p>åœ¨ç¬¬&nbsp;20&nbsp;å’Œ&nbsp;40&nbsp;ä¸ªäº‹ä»¶åè¿›å…¥<strong>é‡Œç¨‹ç¢‘é¢æ¿</strong>ï¼š</p>
        <ul>
          <li>è‹¥èµ„é‡‘è¾¾æ ‡ â†’ ç‚¹å‡»ã€Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µã€ç»§ç»­</li>
          <li>æœªè¾¾æ ‡ â†’ ç«‹å³å¤±è´¥</li>
        </ul>

        <h3>8. é€‰é¡¹å‰ç½®æ¡ä»¶</h3>
        <p>ç°è‰²æŒ‰é’®è¡¨ç¤ºä¸æ»¡è¶³è¯¥é€‰é¡¹çš„æœ€ä½ / æœ€é«˜è¦æ±‚ï¼ˆèµ„é‡‘ã€å¥åº·æˆ–èƒ½åŠ›å€¼ï¼‰ã€‚</p>

        <h3>9. ç»“å±€</h3>
        <ul>
          <li>èµ„é‡‘æˆ–å¥åº· â‰¤ 0 â†’ ã€Œæ¸¸æˆç»“æŸã€</li>
          <li>å­˜æ´»è‡³äº‹ä»¶&nbsp;60 ä¸”èµ„é‡‘ â‰¥ 30ä¸‡â†’ èƒœåˆ©é€šå…³</li>
        </ul>

        <h3>10. å¿«é€ŸæŠ€å·§</h3>
        <ul>
          <li>ä¼˜å…ˆé€‰æ‹©ä¸ä½ <strong>æœ€å¼ºèƒ½åŠ›</strong>ç›¸ç¬¦çš„å·¥ä½œ</li>
          <li>æ—¶åˆ»å…³æ³¨å¥åº·ï¼Œå°¤å…¶æ˜¯åœ¨è¾ƒé«˜éš¾åº¦</li>
        </ul>

        <p style="text-align:center;font-style:italic;">ç¥ä½ åœ¨åŸå¸‚é—¯å‡ºä¸€ç•ªä¼ å¥‡ï¼</p>
      </div>
    </details>
  </div>

  <script>
    const sampleEvents=[
      {"eventID":"1001","stage":1,"eventVersion":"E_pay_E_prob","eventDescription":"<placeholder>","choices":[{"choiceID":1,"choiceDescription":"<placeholder>","requirements":{},"moneyInfluence":[[1,"flat",-200]],"healthInfluence":[],"newJob":{"jobId":"208","jobName":"è®¾è®¡å¸ˆ","category":"technical","basePay":700,"baseHealthCost":2}},{"choiceID":2,"choiceDescription":"<placeholder>","requirements":{},"moneyInfluence":[[1,"flat",-200]],"healthInfluence":[],"newJob":{"jobId":"207","jobName":"è£ç¼","category":"technical","basePay":640,"baseHealthCost":2}},{"choiceID":3,"choiceDescription":"<placeholder>","requirements":{},"moneyInfluence":[[1,"flat",-200]],"healthInfluence":[]} ]},
      {"eventID":"1002","stage":1,"eventVersion":"E_pay_E_prob","eventDescription":"<placeholder>","choices":[{"choiceID":1,"choiceDescription":"<placeholder>","requirements":{},"moneyInfluence":[],"healthInfluence":[],"newJob":{"jobId":"308","jobName":"ä¾›åº”é“¾åè°ƒå‘˜","category":"commercial","basePay":700,"baseHealthCost":2}},{"choiceID":2,"choiceDescription":"<placeholder>","requirements":{},"moneyInfluence":[],"healthInfluence":[],"newJob":{"jobId":"206","jobName":"å®éªŒå®¤åŠ©ç†","category":"technical","basePay":620,"baseHealthCost":2}},{"choiceID":3,"choiceDescription":"<placeholder>","requirements":{},"moneyInfluence":[],"healthInfluence":[]} ]}
    ];

    const stageCosts={
      simple:{1:{rent:100,healthCost:0},2:{rent:200,healthCost:1},3:{rent:300,healthCost:2}, ini: 0.4, dText: 'ç®€å•'},
      medium:{1:{rent:200,healthCost:1},2:{rent:300,healthCost:2},3:{rent:400,healthCost:3}, ini: 0.3, dText: 'ä¸­ç­‰'},
      hard:{1:{rent:300,healthCost:2},2:{rent:500,healthCost:3},3:{rent:700,healthCost:4}, ini: 0.2, dText: 'å›°éš¾'},
      guru:{1:{rent:500,healthCost:2},2:{rent:700,healthCost:4},3:{rent:1000,healthCost:6}, ini: 0.1, dText: 'å¤§å¸ˆ'}
    };
    const milestoneReqs={20:{requirement:20000,message:"ä½ éœ€è¦è‡³å°‘20000èµ„é‡‘æ‰èƒ½ç»§ç»­ã€‚"},40:{requirement:80000,message:"ä½ éœ€è¦è‡³å°‘80000èµ„é‡‘æ‰èƒ½ç»§ç»­ã€‚"},60:{requirement:300000,message:"ä½ éœ€è¦è‡³å°‘300000èµ„é‡‘å®Œæˆæ¸¸æˆï¼"}};

    let thisEvents=sampleEvents.slice();
    fetch('./events.json').then(r=>{if(!r.ok)throw 0;return r.json();}).then(d=>{thisEvents=d;}).catch(()=>{});

    const defaultJob={jobId:"999",jobName:"æ— ä¸š",category:"normal",basePay:0,baseHealthCost:0};

    let playerState={
      money:5000,health:100,charmValue:0,intelligenceValue:0,financeValue:0,strengthValue:0,
      currentJob:JSON.parse(JSON.stringify(defaultJob)),
      originalTechBasePay:0,eventIndex:1,difficulty:"",stage:1
    };

    let actionLog=[],lockedChoice=false;
    function logAction(m){actionLog.push(m);const a=document.getElementById("actionLog");if(a){const p=document.createElement("p");p.textContent=m;a.appendChild(p);}console.log(m);}
    function clampHealth(){if(playerState.health>100)playerState.health=100;if(playerState.health<0)playerState.health=0;}

    function randomStats(total){
      const units=Math.round(total*100);           
      const cuts=new Set();
      while(cuts.size<3){cuts.add(Math.floor(Math.random()*(units+1)));}
      const arr=[0,...Array.from(cuts).sort((a,b)=>a-b),units];
      let parts=[];
      for(let i=0;i<4;i++)parts.push(arr[i+1]-arr[i]);  
      /* randomize the order */
      for(let i=parts.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [parts[i],parts[j]]=[parts[j],parts[i]];
      }
      parts=parts.map(v=>Number((v/100).toFixed(2))); 
      return {charm:parts[0],intel:parts[1],finance:parts[2],strength:parts[3]};
    }

    function pickRandomOutcome(arr,isMoney){
      let r=Math.random(),c=0;
      for(let it of arr){c+=it[0];if(r<=c){if(it[1]==="flat")return it[2];if(it[1]==="skillBased"&&isMoney){let s=playerState[it[2].skillTag]||0;return Math.floor(it[2].base*(1+it[2].multiplier*s));}return 0;}}
      return 0;
    }
    function effectiveHC(raw){if (raw < 0) return Math.round(raw/(1+playerState.strengthValue)*10)/10; else return raw}

    function getStageByEventIndex(i){return i<=20?1:i<=40?2:3;}

    function applyJobAndStageCost(){
      playerState.stage=getStageByEventIndex(playerState.eventIndex);
      const c=stageCosts[playerState.difficulty][playerState.stage];
      const job=playerState.currentJob;

      let pay=0,cat=job.category;
      if(cat==="æ™®é€š"){let m=Math.max(playerState.charmValue,playerState.intelligenceValue,playerState.financeValue);pay=Math.floor(job.basePay*(1+m));}
      else if(cat==="ç¤¾äº¤"){pay=Math.floor(job.basePay*(1+5*playerState.charmValue));}
      else if(cat==="æŠ€æœ¯"){pay=Math.floor(job.basePay);job.basePay+=0.1*job.basePay*playerState.intelligenceValue;}
      else if(cat==="å•†ä¸š"){let mult=1+3*playerState.financeValue,base=job.basePay*mult,fl=job.basePay/(1+playerState.financeValue);pay=Math.floor(base+(Math.random()*2*fl-fl));}
      else if(cat==="ä½“åŠ›"){pay=Math.floor(job.basePay*(1+3*playerState.strengthValue));playerState.strengthValue+=0.01;}
      else pay=job.basePay;
      playerState.money+=pay;

      playerState.health-=effectiveHC(job.baseHealthCost+c.healthCost);
      playerState.money-=c.rent;
      clampHealth();
      logAction(`å·¥èµ„ç»“ç®—å®Œæˆï¼Œèµ„é‡‘=${playerState.money}ï¼Œå¥åº·=${playerState.health.toFixed(1)}`);
      if(playerState.money<0||playerState.health<=0){endGame("èµ„é‡‘æˆ–å¥åº·é™åˆ° 0 ä»¥ä¸‹");return false;}
      return true;
    }

    function checkMilestone(){
      if(milestoneReqs[playerState.eventIndex]){
        const m=milestoneReqs[playerState.eventIndex];
        if(playerState.money<m.requirement){endGame(`æœªæ»¡è¶³é‡Œç¨‹ç¢‘ï¼šéœ€è¦${m.requirement}`);return -1;}
        document.getElementById("eventPanel").classList.add("hidden");
        // document.getElementById("milestonePanel").classList.remove("hidden");
        // document.getElementById("milestoneMessage").textContent=m.message;
        return 1;
      }
      return 0;
    }
    // function proceedFromMilestone(){document.getElementById("milestonePanel").classList.add("hidden");nextEvent();}

    // make sure for each stage, eventType from 1 to 3 each appear at least once, and eventType from 4 to 6 each appear at least twice
    const base = [1, 2, 3, 4, 4, 5, 5, 6, 6]; const predeterminedSeq = [];
    for (let i = 0; i < 3; i++) {predeterminedSeq.push([...base].sort(() => Math.random() - 0.5));}

    function showEvent(){
      if(!applyJobAndStageCost())return;
      milestoneFlag = checkMilestone();

      if (milestoneFlag===-1)return;

      document.getElementById("eventPanel").classList.remove("hidden");
      document.getElementById("proceedButton").classList.add("hidden");
      lockedChoice=false;
      updateUI();

      let pool;
      if(playerState.eventIndex===1){
        pool=thisEvents.filter(e=>Number(e.stage)==1&&Number(e.eventType)==1);
        // consider whether to constrain the pool when the player is jobless
        if(pool.length===0)pool=thisEvents;
      }else if(milestoneFlag==1){
        pool=thisEvents.filter(e=>Number(e.eventID)>=4001+playerState.stage*100&&Number(e.eventID)<=4060+playerState.stage*100);
      }else{
        pool=thisEvents.filter(e=>e.stage===playerState.stage);
        if (playerState.jobId === "999")           pool = pool.filter(e => e.eventType === 1 || e.eventType === 2 || e.eventType === 3 || e.eventType === 6); 
        else if (playerState.eventIndex % 2 === 0) pool = pool.filter(e=>Number(e.eventType)==predeterminedSeq[playerState.stage-1][Math.floor((playerState.eventIndex-20*(playerState.stage-1))/2)-1]);
      }
      if(pool.length===0){
        document.getElementById("eventTitle").textContent=`äº‹ä»¶ #${playerState.eventIndex}`;
        document.getElementById("eventDescription").textContent="æš‚æ— äº‹ä»¶";
        document.getElementById("choiceContainer").innerHTML="";
        document.getElementById("proceedButton").classList.remove("hidden");
        return;
      }

      const ev=pool[Math.floor(Math.random()*pool.length)];
      document.getElementById("eventTitle").textContent=`äº‹ä»¶ #${playerState.eventIndex} [${ev.eventID}]`;
      document.getElementById("eventDescription").textContent=ev.eventDescription;

      const cc=document.getElementById("choiceContainer");
      cc.innerHTML="";
      ev.choices.forEach(c=>{
        const b=document.createElement("button");
        b.className="choiceButton";
        b.innerHTML=`é€‰é¡¹${c.choiceID}: ${c.choiceDescription}`.replace(/\n/g,"<br>");
        if(!meetsRequirement(c.requirements))b.disabled=true;
        b.onclick=()=>{if(lockedChoice)return;lockedChoice=true;applyChoice(ev,c);};
        cc.appendChild(b);
      });
    }

    function meetsRequirement(req){
      if(!req)return true;
      const map={money:"money",health:"health",charm:"charmValue",intelligence:"intelligenceValue",finance:"financeValue",strength:"strengthValue"};
      for (let k in req) {
        const key = map[k] || k;
        if (req[k].min !== undefined && playerState[key] < req[k].min) return false; // Inclusive lower bound
        if (req[k].max !== undefined && playerState[key] > req[k].max) return false; // Inclusive upper bound
      }

      return true;
    }

    function applyChoice(ev,c){
      let ch=[];
      if(c.moneyInfluence){const m=pickRandomOutcome(c.moneyInfluence,true);if(m!==0){playerState.money+=m;ch.push(`èµ„é‡‘${m>=0?"+":""}${m}`);}}
      if(c.healthInfluence){const h=pickRandomOutcome(c.healthInfluence,false);if(h!==0){playerState.health+=h;clampHealth();ch.push(`å¥åº·å€¼${h>=0?"+":""}${h}`);}}

      if(c.charmInfluence){playerState.charmValue+=c.charmInfluence;ch.push(`é­…åŠ›${c.charmInfluence >= 0 ? "+" : ""}${c.charmInfluence}`);}
      if(c.intelligenceInfluence){playerState.intelligenceValue+=c.intelligenceInfluence;ch.push(`æ™ºåŠ›${c.intelligenceInfluence >= 0 ? "+" : ""}${c.intelligenceInfluence}`);}
      if(c.financeInfluence){playerState.financeValue+=c.financeInfluence;ch.push(`è´¢å•†${c.financeInfluence >= 0 ? "+" : ""}${c.financeInfluence}`);}
      if(c.strengthInfluence){playerState.strengthValue+=c.strengthInfluence;ch.push(`ä½“åŠ›${c.strengthInfluence >= 0 ? "+" : ""}${c.strengthInfluence}`);}

      if(c.newJob){
        const newJ=JSON.parse(JSON.stringify(c.newJob));
        if(playerState.currentJob.category==="æŠ€æœ¯")playerState.currentJob.basePay=playerState.originalTechBasePay;
        if(newJ.category==="æŠ€æœ¯")playerState.originalTechBasePay=newJ.basePay;
        playerState.currentJob=newJ;
        ch.push(`è·å¾—å·¥ä½œã€Œ${newJ.jobName}ã€`);
      }

      if(ch.length===0)ch.push("æ— å˜åŒ–");
      document.getElementById("eventDescription").textContent="ç»“æœï¼š"+ch.join("ï¼Œ");
      document.getElementById("choiceContainer").innerHTML="";
      logAction(`äº‹ä»¶${ev.eventID} é€‰${c.choiceID} | ${ch.join(" | ")} || èµ„é‡‘:${playerState.money} å¥åº·:${playerState.health.toFixed(1)} é­…åŠ›:${playerState.charmValue.toFixed(2)} æ™ºåŠ›:${playerState.intelligenceValue.toFixed(2)} è´¢å•†:${playerState.financeValue.toFixed(2)} ä½“åŠ›:${playerState.strengthValue.toFixed(2)}`);
      if(playerState.money<0||playerState.health<=0){endGame("èµ„é‡‘æˆ–å¥åº·é™åˆ° 0 ä»¥ä¸‹");return;}
      document.getElementById("proceedButton").classList.remove("hidden");
      updateUI();
    }

    function nextEvent(){playerState.eventIndex++;if(playerState.eventIndex>60){endGame("æ­å–œä½ å®Œé€šå…³è¿™ä¸€å±€ï¼");return;}showEvent();}
    function endGame(msg){
      ["eventPanel","configPanel"].forEach(id=>document.getElementById(id).classList.add("hidden"));
      document.getElementById("endPanel").classList.remove("hidden");
      document.getElementById("endMessage").textContent=msg;
      logAction("æ¸¸æˆç»“æŸ: "+msg);
    }

    function updateUI(){
      document.getElementById("moneyStatus").textContent=`${playerState.money}`;
      document.getElementById("healthStatus").textContent=`${playerState.health.toFixed(1)}`;
      document.getElementById("jobStatus").textContent=`${playerState.currentJob.jobName}`;
      document.getElementById("charmStatus").textContent=`${playerState.charmValue.toFixed(2)}`;
      document.getElementById("intelligenceStatus").textContent=`${playerState.intelligenceValue.toFixed(2)}`;
      document.getElementById("financeStatus").textContent=`${playerState.financeValue.toFixed(2)}`;
      document.getElementById("strengthStatus").textContent=`${playerState.strengthValue.toFixed(2)}`;
      document.getElementById("progressStatus").textContent=`äº‹ä»¶: ${playerState.eventIndex}/60 | é˜¶æ®µ: ${playerState.stage}`;

      const c=stageCosts[playerState.difficulty][playerState.stage];
      document.getElementById("rentDisplay").textContent=` ${c.rent}`;
      document.getElementById("healthCostDisplay").textContent=` ${effectiveHC(c.healthCost+playerState.currentJob.baseHealthCost)}`;

      let txt="æš‚æ— å·¥ä½œ",cat=playerState.currentJob.category,j=playerState.currentJob;
      if(j.jobId!=="999"){
        if(cat==="ä½“åŠ›")txt=`å·¥èµ„â‰ˆ ${Math.floor(j.basePay*(1+3*playerState.strengthValue))}ï¼Œä½“åŠ›å€¼æ¯å›åˆ+0.01ï¼Œå·¥èµ„éšä½“åŠ›å€¼å¢åŠ `;
        else if(cat==="ç¤¾äº¤")txt=`å·¥èµ„â‰ˆ ${Math.floor(j.basePay*(1+5*playerState.charmValue))}ï¼Œå·¥èµ„å¤§å¹…éšé­…åŠ›å€¼å¢åŠ `;
        else if(cat==="æŠ€æœ¯")txt=`å·¥èµ„â‰ˆ ${Math.floor(j.basePay)}ï¼Œå·¥èµ„é€æ¸å¢åŠ ï¼Œå¢å¹…ä¸æ™ºåŠ›å€¼ç›¸å…³`;
        else if(cat==="å•†ä¸š"){let m=1+3*playerState.financeValue,b=j.basePay*m,f=j.basePay/(1+playerState.financeValue);txt=`å·¥èµ„èŒƒå›´ [${Math.floor(b-f)},${Math.floor(b+f)}]`; }
        else{let mx=Math.max(playerState.charmValue,playerState.intelligenceValue,playerState.financeValue);txt=`å·¥èµ„â‰ˆ ${Math.floor(j.basePay*(1+mx))}ï¼Œå·¥èµ„éšå½“å‰æœ€é«˜èƒ½åŠ›å€¼å°å¹…å¢åŠ `;}
      }
      document.getElementById("jobPayDisplay").textContent=txt;
    }

    document.getElementById("difficultySelect").onchange=function(){
      const d=this.value,info=document.getElementById("difficultyInfo");
      if(!d){info.textContent="";document.getElementById("startButton").disabled=true;return;}
      const c1=stageCosts[d][1],c2=stageCosts[d][2],c3=stageCosts[d][3],stageIni=stageCosts[d].ini, dText=stageCosts[d].dText;
      info.innerHTML=`éš¾åº¦: ${dText}<br>é˜¶æ®µ1 ç§Ÿé‡‘${c1.rent} å¥åº·æ¶ˆè€—${c1.healthCost}<br>é˜¶æ®µ2 ç§Ÿé‡‘${c2.rent} å¥åº·æ¶ˆè€—${c2.healthCost}<br>é˜¶æ®µ3 ç§Ÿé‡‘${c3.rent} å¥åº·æ¶ˆè€—${c3.healthCost}<br>åˆå§‹éšæœºèƒ½åŠ›å€¼ï¼š${stageIni}`;
      document.getElementById("startButton").disabled=false;
    };
    document.getElementById("startButton").onclick=function(){
      let diffSel=document.getElementById("difficultySelect").value;
      let target=stageCosts[diffSel].ini;
      let rnd=randomStats(target);
      playerState={
        money:5000,health:100,
        charmValue:rnd.charm,intelligenceValue:rnd.intel,
        financeValue:rnd.finance,strengthValue:rnd.strength,
        currentJob:JSON.parse(JSON.stringify(defaultJob)),
        originalTechBasePay:0,eventIndex:1,difficulty:diffSel,stage:1
      };
      actionLog=[];document.getElementById("actionLog").innerHTML="";
      document.getElementById("configPanel").classList.add("hidden");
      ["statusPanel","eventPanel","logPanel"].forEach(id=>document.getElementById(id).classList.remove("hidden"));
      showEvent();
    };
    document.getElementById("proceedButton").onclick=nextEvent;
    // document.getElementById("milestoneProceedButton").onclick=proceedFromMilestone;
    document.getElementById("restartButton").onclick=function(){
      document.getElementById("configPanel").classList.remove("hidden");
      ["statusPanel","eventPanel","logPanel","endPanel","milestonePanel"].forEach(id=>document.getElementById(id).classList.add("hidden"));
    };
  </script>
</body>
</html>